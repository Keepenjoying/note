# Linux内和分析（二）操作系统是如何工作的


##一、计算机系统是怎么样工作及mykernel代码分析
（一）内容概述
本次文章的内容主要讲述了计算机系统是如何进行进程调度的，代码部分大家可以参见网易云课堂中USTC孟宁老师的第二周的实验内容。实际上我们知道计算机中对进程的定义是：进程（Process）是计算机中的程序关于某数据集合上的一次运行活动，是系统进行`资源分配和调度的基本单位`，是操作系统结构的基础。在早期面向进程设计的计算机结构中，进程是程序的基本执行实体；在当代面向线程设计的计算机结构中，进程是线程的容器。程序是指令、数据及其组织形式的描述，进程是程序的实体。

所以我们可以看出进程的一个首要的特点是系统进行资源分配及调度的一个单位。所以我们得出一个结论就是一个进程需要执行的时候操作系统是需要对他分配相应的`资源`的。这里的资源指的就是计算机的硬件和系统资源。比如这个进程需要运行的内存空间，系统中负责指向运行指令的IP指针，运算需要用到的一些寄存器，系统的调度（实际上就是系统开始运行这个进程了）等等。但是计算机不可能只有一个进程一直在运行，他会有很多进程。而CPU只有一个（假设是个单核的系统，即使是多和计算机也不可能核心数大于进程执行数量）所以系统需要给进程分配CPU这个硬件资源。最简单的方式就是大家轮流使用CPU，每个人都用一会儿之后再给别人用，这样在一段时间之后每个进程都会被计算机执行到。这就是所谓的`时间片轮转法`的调度。


`那么问题就来了`，进程之间切换的时候是如何进行的呢。我们知道不同进程运行需要的内存空间是不一样的。就像是每个函数都有自己的堆栈一样（上篇文章说过）。`所以在进程切换时候首先需要做的就是讲这个进程当前执行到的位置（一个内存的地址——CS：IP）保存起来[1]`，这样下次等到他得到CPU开始执行的时候至少系统可以知道从哪开始继续运行它。那么除了上述的这个运行位置需要保存起来还有什么东西也是需要记录并用于恢复进程的呢？

我们还是用函数作为类比，我们假设函数就是一个简单的数值运算处理，那么处理的时候也会用到很多的变量用于运算步骤中的结果或者中间值的保存，这些数值有些保存在自己的内存堆栈中，有些则是CPU的寄存器中。`那么问题又来了`，这些寄存器有的是通用寄存器大家都要用。所以计算的中间结果如果保存到这里的话，别的函数也会用到这些寄存器用于数值处理，所以上一个函数的这些数值就被覆盖了，即使是恢复到之前运行的内存地址，中间结果不对，执行结果也不会正确。`所以其次需要保存就是这些中间值，我们也可以叫他们保存现场`，这样的话在恢复的时候看起来就差不多不会出问题了（实际上可能需要保存的信息还有很多但是他们的目的都是讲这个进程可能用到的系统资源复制出来，这样即使别人篡改了这些公共资源中的一些，回来时还能恢复到执行时候的样子）。

##（二）代码分析
那么现在我们就可以开始做实验了，mykernel代码实际上就实现了一个基于时间片轮转的系统调度。我们首先来看一下他的代码结构。

20150315113333494.png