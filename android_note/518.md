# Android 核心使用 kgdb

- android source code

```c
https://android.googlesource.com/platform/manifest/
```

```
mkdir android-5.1.1_r9
cd android-5.1.1_r9
repo init -u https://android.googlesource.com/platform/manifest -b android-5.1.1_r9
repo sync -j8
```

- checkout goldfish 源碼： 模擬器使用的kernel 是 goldfish

```c
cd android-5.1.1_r9
mkdir kernel
cd kernel
git clone https://android.googlesource.com/kernel/goldfish.git git
checkout -t origin/android-goldfish-3.4 -b goldfish3.4
```
```sh
CONFIG_HIGHMEM=y 打開這個選項後，啟動模擬器時 emulator -memory
參數才能發揮作用，否則模擬器的內存總是700多M
CONFIG_DEBUG_KERNEL=y 打開這個選項後，vmlinux 才有符號
CONFIG_KGDB=y 開啟kgdb
CONFIG_DEBUG_INFO=y
```

```sh
#!/bin/bash

TOP=`pwd`

usage() {
cat <<USAGE

Usage:
    bash $0 <TARGET_PRODUCT> [OPTIONS]

Description:
    Builds Android tree for given TARGET_PRODUCT

OPTIONS:
    -c, --clean_build
        Clean build - build from scratch by removing entire out dir

    -d, --debug
        Enable debugging - captures all commands while doing the build

    -h, --help
        Display this help message

    -i, --image
        Specify image to be build/re-build (bootimg/sysimg/usrimg)

    -j, --jobs
        Specifies the number of jobs to run simultaneously (Default: 8)

    -k, --kernel_defconf
        Specify defconf file to be used for compiling Kernel

    -l, --log_file
        Log file to store build logs (Default: <TARGET_PRODUCT>.log)

    -m, --module
        Module to be build

    -p, --project
        Project to be build

    -s, --setup_ccache
        Set CCACHE for faster incremental builds (true/false - Default: true)

    -u, --update-api
        Update APIs

    -v, --build_variant
        Build variant (Default: userdebug)

USAGE
}

buid_kernel() {
    export PATH=$TOP/prebuilts/gcc/linux-x86/arm/arm-eabi-4.8/bin:$PATH
    export ARCH=arm
    export SUBARCH=arm
    export CROSS_COMPILE=arm-eabi-
    make -C kernel/goldfish goldfish_armv7_defconfig
    sed -i 's/.*CONFIG_HIGHMEM.*/CONFIG_HIGHMEM=y/' kernel/goldfish/.config
    sed -i 's/.*CONFIG_DEBUG_KERNEL.*/CONFIG_DEBUG_KERNEL=y/' kernel/goldfish/.config
    sed -i 's/.*CONFIG_KGDB.*/CONFIG_KGDB=y/' kernel/goldfish/.config
    sed -i 's/.*CONFIG_DEBUG_INFO.*/CONFIG_DEBUG_INFO=y/' kernel/goldfish/.config
    yes '' | make -C kernel/goldfish oldconfig
    make -C kernel/goldfish clean
    time  make -C kernel/goldfish  V=1 -k -j8 2>&1 | tee kernel_build.log
}

build_env() {
    source $TOP/build/envsetup.sh;
    lunch aosp_arm-eng;
}

debug_emulator() {
    build_env
    emulator  -no-audio -verbose -show-kernel -kernel kernel/goldfish/arch/arm/boot/zImage -memory 2048 -qemu -s -S
}

run_emulator() {
    build_env
    emulator -kernel kernel/goldfish/arch/arm/boot/zImage
    #emulator -verbose -show-kernel -netfast -kernel kernel/goldfish/arch/arm/boot/zImage  -partition-size 1024 -qemu -monitor telnet::6666,server
}

while true; do
    case "$1" in
        -h|--help) usage; exit 0;;
        -k|--kernel) buid_kernel; exit 0;;
        -e|--env) build_env; exit 0;;
        -r|--run) run_emulator; exit 0;;
        -d|--debug) debug_emulator; exit 0;;
        --) shift; break;;
    esac
    shift
done
```

- build.env

```sh
source $TOP/build/envsetup.sh;
lunch aosp_arm-eng;
}
```

```sh
source build.env
```

- gdbinit

```sh
target remote localhost:1234
b *start_kernel
```

```sh
arm-linux-androideabi-gdb goldfish/vmlinux
source gdbinit
```

